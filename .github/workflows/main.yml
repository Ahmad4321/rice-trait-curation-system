name: Update Directory Tree
on:
  push:
    branches: [main, master]
    paths-ignore: ['README.md']

# Critical permission setup
permissions:
  contents: write
  pull-requests: write

jobs:
  update-tree:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup Git and Tree
        run: |
          # Configure Git
          git config --global user.name "Ahmad4321"
          git config --global user.email "ahmadjaved870@gmail.com"
          
          # Install tree command
          sudo apt-get update && sudo apt-get install -y tree

      - name: Generate Updated Tree
        run: |
          # Create temporary file
          tree -L 3 --dirsfirst -I "node_modules|.git|dist" > tmp_tree.txt
          
          # Update README between markers
          awk -v tree="$(cat tmp_tree.txt)" '
          /<!-- TREE START -->/ {print; print "```"; print tree; print "```"; skip=1}
          /<!-- TREE END -->/ {skip=0}
          !skip {print}
          ' README.md > tmp_readme.md && mv tmp_readme.md README.md

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Auto-update directory tree"
          token: ${{ secrets.GH_PAT }}
          branch: ${{ github.ref_name }}
